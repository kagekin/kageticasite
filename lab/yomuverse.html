<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yomuverse - Online Reading Metaverse</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        yomu: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 900: '#0c4a6e' },
                        wood: '#8B4513',
                        paper: '#F5F5DC'
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                        serif: ['"Shippori Mincho"', 'serif']
                    }
                }
            }
        }
    </script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Konva -->
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #2c2c2c;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .pdf-layer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .avatar-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .konva-layer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .avatar {
            transition: all 0.5s ease-out;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Mock Data & Utils ---
        const PASTEL_COLORS = ['#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF', '#E6E6FA'];

        const generateAvatar = (name) => {
            const initial = name ? name.charAt(0).toUpperCase() : '?';
            const color = PASTEL_COLORS[Math.floor(Math.random() * PASTEL_COLORS.length)];
            return { initial, color };
        };

        const Icon = ({ name, size = 20, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide) {
                    const iconNode = window.lucide.icons[name];
                    if (iconNode) {
                        const svg = window.lucide.createElement(iconNode);
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        if (className) svg.setAttribute('class', className);
                        ref.current.innerHTML = '';
                        ref.current.appendChild(svg);
                    }
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center" />;
        };

        // --- Components ---

        const LoginScreen = ({ onJoin }) => {
            const [name, setName] = useState('');
            const [avatar, setAvatar] = useState(generateAvatar(''));

            useEffect(() => { setAvatar(generateAvatar(name)); }, [name]);

            return (
                <div className="flex items-center justify-center min-h-screen bg-slate-900 text-white">
                    <div className="bg-slate-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700">
                        <h1 className="text-3xl font-serif font-bold text-center mb-2">Yomuverse</h1>
                        <p className="text-slate-400 text-center mb-8 text-sm">Online Reading Metaverse</p>

                        <div className="flex justify-center mb-6">
                            <div className="w-24 h-24 rounded-full flex items-center justify-center text-4xl font-bold shadow-lg ring-4 ring-white/10" style={{ backgroundColor: avatar.color, color: '#333' }}>
                                {avatar.initial}
                            </div>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-1">Display Name</label>
                                <input
                                    type="text"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    className="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-sky-500 text-white placeholder-slate-500"
                                    placeholder="Enter your name..."
                                />
                            </div>
                            <button
                                onClick={() => name && onJoin(name, avatar)}
                                disabled={!name}
                                className="w-full bg-sky-500 hover:bg-sky-400 disabled:bg-slate-600 disabled:cursor-not-allowed text-white font-bold py-3 rounded-lg transition-all shadow-lg shadow-sky-500/20"
                            >
                                Enter World
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Clock = () => {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            return <div className="font-mono text-xl">{time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>;
        };

        const AvatarField = ({ me, others, width, height }) => {
            return (
                <div className="avatar-layer" style={{ width, height }}>
                    {/* Other Avatars */}
                    {others.map(user => (
                        <div key={user.id} className="avatar absolute flex flex-col items-center" style={{ left: user.x, top: user.y, transform: 'translate(-50%, -50%)' }}>
                            <div className="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm shadow-md border-2 border-white/50" style={{ backgroundColor: user.color, color: '#333' }}>
                                {user.initial}
                            </div>
                            <div className="text-white text-xs bg-black/50 px-2 py-0.5 rounded mt-1 backdrop-blur-sm">{user.name}</div>
                        </div>
                    ))}

                    {/* My Avatar */}
                    {me && (
                        <div className="avatar absolute flex flex-col items-center z-10" style={{ left: me.x, top: me.y, transform: 'translate(-50%, -50%)' }}>
                            <div className="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg shadow-lg ring-4 ring-sky-400" style={{ backgroundColor: me.color, color: '#333' }}>
                                {me.initial}
                            </div>
                            <div className="text-white text-xs bg-black/50 px-2 py-0.5 rounded mt-1 backdrop-blur-sm font-bold">{me.name} (You)</div>
                        </div>
                    )}
                </div>
            );
        };

        const YomuverseApp = ({ user }) => {
            // State
            const [myPos, setMyPos] = useState({ x: window.innerWidth / 2, y: window.innerHeight - 100 });
            const [others, setOthers] = useState([]);
            const [audioMode, setAudioMode] = useState('OFF'); // OFF (Conference), ON (Party)
            const [tool, setTool] = useState('cursor'); // cursor, pen, highlighter, eraser, sticky
            const [isMuted, setIsMuted] = useState(false);
            const [scale, setScale] = useState(1);
            const [notes, setNotes] = useState([]);
            const [page, setPage] = useState(1);

            // Mock Data Generation
            useEffect(() => {
                // Simulate other users joining/moving (Mock Logic Remained)
                const mockUsers = [
                    { id: 1, name: 'Alice', initial: 'A', color: '#FFB3BA', x: 200, y: 300, targetX: 200, targetY: 300 },
                    { id: 2, name: 'Bob', initial: 'B', color: '#BAE1FF', x: 800, y: 200, targetX: 800, targetY: 200 },
                    { id: 3, name: 'Charlie', initial: 'C', color: '#FFFFBA', x: 500, y: 600, targetX: 500, targetY: 600 },
                ];
                setOthers(mockUsers);

                const interval = setInterval(() => {
                    setOthers(prev => prev.map(u => {
                        // Random movement simulation
                        if (Math.random() < 0.05) {
                            return { ...u, targetX: Math.random() * window.innerWidth, targetY: Math.random() * window.innerHeight };
                        }
                        // Lerp movement
                        return {
                            ...u,
                            x: u.x + (u.targetX - u.x) * 0.1,
                            y: u.y + (u.targetY - u.y) * 0.1
                        };
                    }));
                }, 50);
                return () => clearInterval(interval);
            }, []);

            // Konva State
            const stageRef = useRef(null);
            const layerRef = useRef(null);
            const isDrawing = useRef(false);

            useEffect(() => {
                // Init Konva
                if (!document.getElementById('konva-container')) return;

                const stage = new Konva.Stage({
                    container: 'konva-container',
                    width: 600,
                    height: 850,
                });

                const layer = new Konva.Layer();
                stage.add(layer);

                stageRef.current = stage;
                layerRef.current = layer;

                // Drawing Events
                stage.on('mousedown touchstart', () => {
                    if (tool !== 'pen' && tool !== 'highlighter' && tool !== 'eraser') return;
                    isDrawing.current = true;
                    const pos = stage.getPointerPosition();

                    let config = {
                        points: [pos.x, pos.y],
                        lineCap: 'round',
                        lineJoin: 'round',
                    };

                    if (tool === 'pen') {
                        config = { ...config, stroke: '#ff0055', strokeWidth: 3, globalCompositeOperation: 'source-over' };
                    } else if (tool === 'highlighter') {
                        config = { ...config, stroke: '#ffff00', strokeWidth: 20, opacity: 0.5, globalCompositeOperation: 'source-over' };
                    } else if (tool === 'eraser') {
                        config = { ...config, stroke: '#000000', strokeWidth: 20, globalCompositeOperation: 'destination-out' };
                    }

                    const newLine = new Konva.Line(config);
                    layer.add(newLine);
                });

                stage.on('mousemove touchmove', () => {
                    if (!isDrawing.current) return;
                    if (tool !== 'pen' && tool !== 'highlighter' && tool !== 'eraser') return;

                    const pos = stage.getPointerPosition();
                    const lastLine = layer.children[layer.children.length - 1];
                    if (lastLine) {
                        const newPoints = lastLine.points().concat([pos.x, pos.y]);
                        lastLine.points(newPoints);
                    }
                });

                stage.on('mouseup touchend', () => {
                    isDrawing.current = false;
                });

                return () => stage.destroy();
            }, [tool]);

            // Handlers
            const handleFieldClick = (e) => {
                // If clicking content/buttons, ignore (handled by propagation stop usually, but check target)
                if (e.target.closest('button') || e.target.closest('.pdf-layer')) return;

                if (tool === 'cursor') {
                    setMyPos({ x: e.clientX, y: e.clientY });
                } else if (tool === 'sticky') {
                    const id = Date.now();
                    // Basic positioning relative to screen for prototype (ideally logic relative to PDF if inside, but field is global)
                    setNotes(prev => [...prev, { id, x: e.clientX, y: e.clientY, text: '', author: user.initial, color: user.color }]);
                    setTool('cursor'); // Reset tool after placing
                }
            };

            const toggleAudioMode = () => setAudioMode(prev => prev === 'OFF' ? 'ON' : 'OFF');
            const toggleMute = () => setIsMuted(!isMuted);

            const handleStickyChange = (id, text) => {
                setNotes(prev => prev.map(n => n.id === id ? { ...n, text } : n));
            };
            const deleteSticky = (id) => {
                setNotes(prev => prev.filter(n => n.id !== id));
            };

            return (
                <div className="w-full h-screen bg-[#2c2c2c] overflow-hidden relative cursor-crosshair" onClick={handleFieldClick}
                    style={{ backgroundImage: 'url("https://www.transparenttextures.com/patterns/wood-pattern.png")', backgroundBlendMode: 'multiply' }}>

                    {/* --- PDF / Content Space (Mock) --- */}
                    <div className="pdf-layer bg-white w-[600px] h-[850px] flex items-center justify-center text-slate-300 shadow-2xl transition-transform"
                        style={{ transform: `translate(-50%, -50%) scale(${scale})` }}>
                        <div className="text-center">
                            <Icon name="FileText" size={64} className="mb-4 opacity-50 mx-auto" />
                            <h2 className="text-2xl font-serif text-slate-800 mb-2">Lorem Ipsum Book</h2>
                            <p className="text-slate-500">Page {page} / 10</p>
                            <div className="mt-8 p-4 border border-dashed border-slate-300 rounded text-left w-3/4 mx-auto text-sm text-slate-800 font-serif leading-loose">
                                {page === 1 ? '吾輩は猫である。名前はまだ無い。' : `This is content for page ${page}.`}
                                <br />
                                {page === 1 && 'どこで生れたかとんと見当がつかぬ。'}
                                {page === 1 && <br />}
                                {page === 1 && '何でも薄暗いじめじめした所でニャーニャー泣いていた事だけは記憶している。'}
                                {page === 1 && <br />}
                                {page === 1 && '吾輩はここで始めて人間というものを見た。'}
                                {page === 1 && <br />}
                                {page === 1 && 'しかもあとで聞くとそれは書生という人間中で一番獰悪な種族であったそうだ。'}
                                {page === 1 && <br />}
                                {page === 1 && 'この書生というのは時々我々を捕えて煮て食うという話である。'}
                                {page === 1 && <br />}
                                {page === 1 && 'しかしその当時は何という考もなかったから別段恐しいとも思わなかった。'}
                            </div>
                        </div>
                    </div>

                    {/* --- Avatar Layer --- */}
                    <AvatarField me={{ ...user, ...myPos }} others={others} width="100%" height="100%" />

                    {/* --- HUD --- */}
                    {/* Header */}
                    <header className="absolute top-0 left-0 w-full p-4 flex justify-between items-start pointer-events-none">
                        <div className="bg-black/60 backdrop-blur-md text-white px-4 py-2 rounded-lg flex items-center gap-4 shadow-lg pointer-events-auto">
                            <h1 className="font-bold font-serif tracking-widest text-sky-400">Yomuverse</h1>
                            <div className="w-px h-4 bg-white/20"></div>
                            <Clock />
                        </div>

                        <div className="bg-black/60 backdrop-blur-md text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-lg pointer-events-auto">
                            <Icon name="Users" size={16} className="text-emerald-400" />
                            <span className="font-mono font-bold">{others.length + 1}</span>
                            <span className="text-xs text-slate-400">Online</span>
                        </div>
                    </header>

                    {/* Audio Controls */}
                    <div className="absolute top-20 right-4 flex flex-col gap-2 pointer-events-none">
                        <div className={`bg-black/60 backdrop-blur pointer-events-auto p-2 rounded-lg text-xs font-bold text-center border-l-4 shadow-lg w-32 transition-all ${audioMode === 'ON' ? 'border-purple-500 bg-purple-900/60' : 'border-sky-500'}`}>
                            <div className="text-[10px] text-white/50 mb-1">AUDIO MODE</div>
                            <button onClick={toggleAudioMode} className="flex items-center justify-center gap-2 w-full text-white">
                                {audioMode === 'OFF' ? (
                                    <>
                                        <Icon name="Mic" size={16} /> Conference
                                    </>
                                ) : (
                                    <>
                                        <Icon name="Wine" size={16} /> Party
                                    </>
                                )}
                            </button>
                        </div>
                    </div>

                    {/* Sticky Notes Layer */}
                    {notes.map(note => (
                        <div key={note.id} className="absolute w-40 h-40 bg-yellow-100 shadow-xl rounded p-2 text-sm font-hand"
                            style={{ left: note.x, top: note.y, transform: 'translate(-50%, -50%) rotate(-2deg)' }}>
                            <div className="flex justify-between items-center mb-1 border-b border-yellow-200 pb-1">
                                <div className="flex items-center gap-1">
                                    <div className="w-4 h-4 rounded-full text-[10px] flex items-center justify-center font-bold" style={{ background: note.color }}>{note.author}</div>
                                    <span className="text-[10px] text-slate-500">{new Date(note.id).toLocaleTimeString()}</span>
                                </div>
                                <button onClick={(e) => { e.stopPropagation(); deleteSticky(note.id); }} className="text-red-400 hover:text-red-600">
                                    <Icon name="X" size={12} />
                                </button>
                            </div>
                            <textarea
                                className="w-full h-28 bg-transparent focus:outline-none resize-none"
                                value={note.text}
                                onChange={(e) => handleStickyChange(note.id, e.target.value)}
                                placeholder="Type here..."
                                onClick={(e) => e.stopPropagation()}
                            />
                        </div>
                    ))}

                    {/* Toolbar (Bottom) */}
                    <div className="absolute bottom-8 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur-xl text-white px-3 py-2 rounded-full border border-slate-700 shadow-2xl flex items-center gap-2 pointer-events-auto z-50">
                        <button onClick={toggleMute} className={`p-3 rounded-full transition-all ${isMuted ? 'bg-red-500 text-white' : 'hover:bg-slate-700 text-slate-400'}`} title="Mute">
                            <Icon name={isMuted ? "MicOff" : "Mic"} size={20} />
                        </button>
                        <div className="w-px h-6 bg-slate-700 mx-1"></div>

                        <button onClick={() => setTool('cursor')} className={`p-3 rounded-full transition-all ${tool === 'cursor' ? 'bg-sky-500 text-white' : 'hover:bg-slate-700 text-slate-400 hover:text-white'}`} title="Move">
                            <Icon name="MousePointer2" size={20} />
                        </button>

                        <button onClick={() => setTool('pen')} className={`p-3 rounded-full transition-all ${tool === 'pen' ? 'bg-sky-500 text-white' : 'hover:bg-slate-700 text-slate-400 hover:text-white'}`} title="Pen">
                            <Icon name="PenTool" size={20} />
                        </button>

                        <button onClick={() => setTool('highlighter')} className={`p-3 rounded-full transition-all ${tool === 'highlighter' ? 'bg-sky-500 text-white' : 'hover:bg-slate-700 text-slate-400 hover:text-white'}`} title="Highlighter">
                            <Icon name="Highlighter" size={20} />
                        </button>

                        <button onClick={() => setTool('eraser')} className={`p-3 rounded-full transition-all ${tool === 'eraser' ? 'bg-sky-500 text-white' : 'hover:bg-slate-700 text-slate-400 hover:text-white'}`} title="Eraser">
                            <Icon name="Eraser" size={20} />
                        </button>

                        <button onClick={() => setTool('sticky')} className={`p-3 rounded-full transition-all ${tool === 'sticky' ? 'bg-sky-500 text-white' : 'hover:bg-slate-700 text-slate-400 hover:text-white'}`} title="Sticky Note">
                            <Icon name="StickyNote" size={20} />
                        </button>

                        <div className="w-px h-6 bg-slate-700 mx-1"></div>

                        <button onClick={() => setScale(s => Math.max(0.5, s - 0.1))} className="p-3 rounded-full hover:bg-slate-700 text-slate-400 hover:text-white">
                            <Icon name="ZoomOut" size={20} />
                        </button>
                        <span className="text-xs font-mono w-12 text-center text-slate-500">{Math.round(scale * 100)}%</span>
                        <button onClick={() => setScale(s => Math.min(2, s + 0.1))} className="p-3 rounded-full hover:bg-slate-700 text-slate-400 hover:text-white">
                            <Icon name="ZoomIn" size={20} />
                        </button>
                    </div>

                    {/* PDF Nav (Floating near PDF) */}
                    <div className="absolute top-1/2 -translate-y-1/2 left-4 z-20 pointer-events-auto">
                        <button onClick={() => setPage(p => Math.max(1, p - 1))} className="bg-slate-900/50 hover:bg-slate-900 p-4 rounded-full text-white backdrop-blur shadow-lg">
                            <Icon name="ChevronLeft" size={24} />
                        </button>
                    </div>
                    <div className="absolute top-1/2 -translate-y-1/2 right-4 z-20 pointer-events-auto">
                        <button onClick={() => setPage(p => p + 1)} className="bg-slate-900/50 hover:bg-slate-900 p-4 rounded-full text-white backdrop-blur shadow-lg">
                            <Icon name="ChevronRight" size={24} />
                        </button>
                    </div>

                    {/* Tooltip Instruction */}
                    <div className="absolute bottom-24 left-1/2 -translate-x-1/2 text-white/50 text-xs pointer-events-none animate-pulse">
                        Click anywhere to move avatar
                    </div>

                </div>
            );
        };

        const Main = () => {
            const [user, setUser] = useState(null);
            return user ? <YomuverseApp user={user} /> : <LoginScreen onJoin={(name, avatar) => setUser({ name, ...avatar })} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Main />);
    </script>
</body>

</html>