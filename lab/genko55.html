<!DOCTYPE html>
<!--
  MIT License

  Copyright (c) 2026 Yoshida Kagetica

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to deal
  in the Software without restriction, including without limitation the rights
  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in all
  copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  SOFTWARE.
-->
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŸç¨¿é€²è¡Œã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥</title>
  <meta property="og:title" content="åŸç¨¿é€²è¡Œã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥">
  <meta property="og:description" content="æ¼«ç”»ã‚„å°èª¬ã®åŸç¨¿é€²æ—ã‚’ç®¡ç†ã—ã€ãƒšãƒ¼ã‚¹ã«åˆã‚ã›ã¦åŠ±ã¾ã—ã¦ãã‚Œã‚‹ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ã‚¢ãƒ—ãƒªã§ã™ã€‚">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://kagetica.net/lab/genko55.html">
  <meta property="og:image" content="https://kagetica.net/assets/genko55/ogp-genko55.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@kagetica">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
    .selection-pink::selection {
      background-color: #fbcfe8;
    }

    body {
      font-family: sans-serif;
    }

    /* éš ã—è¦ç´ ç”¨ã‚¯ãƒ©ã‚¹ */
    .d-none {
      display: none !important;
    }
  </style>
</head>

<body class="bg-[#fcfbf9] text-gray-900 selection-pink min-h-screen pb-20">
  <div id="app" class="max-w-md mx-auto p-4 sm:p-6"></div>

  <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ (localStorageä¿å­˜ç‰ˆ) -->
  <script type="module">
    // --- å®šæ•°å®šç¾© ---
    const MANGA_STEPS = [
      { id: 'plot', name: 'ãƒ—ãƒ­ãƒƒãƒˆ' },
      { id: 'name', name: 'ãƒãƒ¼ãƒ ' },
      { id: 'draft', name: 'ä¸‹æ›¸ã' },
      { id: 'pen', name: 'ãƒšãƒ³å…¥ã‚Œ' },
      { id: 'tone', name: 'ãƒˆãƒ¼ãƒ³ãƒ»ä»•ä¸Š' }
    ];

    const NOVEL_STEPS = [
      { id: 'plot', name: 'ãƒ—ãƒ­ãƒƒãƒˆ' },
      { id: 'draft', name: 'æœ¬æ–‡åŸ·ç­†' },
      { id: 'revise', name: 'æ¨æ•²' },
      { id: 'proofread', name: 'æ ¡æ­£' }
    ];

    const DEFAULT_PROJECT = {
      title: "æ–°åˆŠãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ",
      type: "manga",
      totalUnits: 30,
      unitName: "P",
      startDate: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      targetPace: 2, // ç›®æ¨™ãƒšãƒ¼ã‚¹ã®æ•°å€¤
      targetPacePeriod: 'day' // ç›®æ¨™ãƒšãƒ¼ã‚¹ã®æœŸé–“ ('day', 'week', 'month')
    };

    const DEFAULT_TIPS = [
      "ã“ã¾ã‚ã«ä¿å­˜ï¼ˆCtrl+S / Cmd+Sï¼‰ã‚’å¿˜ã‚Œãªã„ã§ã­ï¼\næ¯ã‚’ã™ã‚‹ã‚ˆã†ã«ä¿å­˜ï¼",
      "ç–²ã‚ŒãŸã‚‰15åˆ†ã ã‘ä»®çœ ã‚’ã¨ã‚‹ã¨ã‚¹ãƒƒã‚­ãƒªã™ã‚‹ã‚ˆã€‚\nå¯ã™ãã«ã¯æ³¨æ„ï¼",
      "æ°´åˆ†è£œçµ¦ã¯ã—ã£ã‹ã‚Šã­ï¼\nã‚³ãƒ¼ãƒ’ãƒ¼ã‚„ã‚¨ãƒŠã‚¸ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã®é£²ã¿éãã¯ç¦ç‰©ã ã‚ˆã€‚",
      "ã©ã†ã—ã¦ã‚‚ã‚„ã‚‹æ°—ãŒå‡ºãªã„æ™‚ã¯ã€\nã¨ã‚Šã‚ãˆãšæœºã«å‘ã‹ã£ã¦1åˆ†ã ã‘ä½œæ¥­ã—ã¦ã¿ã‚ˆã†ï¼",
      "æ‰‹é¦–ã‚„è‚©ã®ã‚¹ãƒˆãƒ¬ãƒƒãƒã‚’ã—ã¦ãŠã“ã†ï¼\nä½“ãŒè³‡æœ¬ã ã‹ã‚‰ã­ï¼",
      "æ¤…å­ã«åº§ã‚Šã£ã±ãªã—ã¯ä½“ã«æ¯’ã ã‚ˆã€‚\n30åˆ†ã«1å›ã¯ç«‹ã¡ä¸ŠãŒã£ã¦æ­©ãå›ã‚ã†ï¼",
      "é›†ä¸­åŠ›ã‚’é«˜ã‚ãŸã„æ™‚ã¯ã€ç”»é¢ã®ç‰¹å®šã®1ç‚¹ï¼ˆæ–‡å­—ã‚„è‰²ï¼‰ã‚’æ•°åˆ†é–“ã˜ã£ã¨\nç¬ãã›ãšã«è¦‹ã¤ã‚ç¶šã‘ã‚‹ã¨ã„ã„ã‚‰ã—ã„ã‚ˆã€‚çŸ¥ã‚‰ã‚“ã‘ã©ã€‚"
    ].join("\n\n");

    const DEFAULT_LUCKY_MESSAGES = [
      "ä»Šæ—¥ã¯ã€ä¸€ç²’ä¸‡å€æ—¥ã€ï¼\næ–°ã—ã„ä½œæ¥­ã‚’å§‹ã‚ã‚‹ã®ã«æœ€å¼·ã®æ—¥ã ã‚ˆï¼",
      "ä»Šæ—¥ã¯ã€å¤©èµ¦æ—¥ã€ï¼\nã¤ã¾ãšã„ã¦ã„ãŸã‚·ãƒ¼ãƒ³ã‚’ä¸€æ°—ã«é€²ã‚ã‚‹ãƒãƒ£ãƒ³ã‚¹ï¼",
      "ä»Šæ—¥ã¯ã€å¤§å®‰ã€ï¼\nä½•äº‹ã‚‚ã†ã¾ãã„ãæ—¥ï¼ä½œæ¥­ãŒã‚µã‚¯ã‚µã‚¯ã¯ã‹ã©ã‚‹ã‹ã‚‚ï¼",
      "ä»Šæ—¥ã¯ã€å¯…ã®æ—¥ã€ï¼\nè³‡æ–™ã‚„ç´ æã‚’è²·ã†ãªã‚‰ä»Šæ—¥ãŒãŠã™ã™ã‚ï¼",
      "ä»Šæ—¥ã¯ã€å·±å·³ã®æ—¥ã€ï¼\nèŠ¸è¡“ã®å¥³ç¥ã®ç¸æ—¥ï¼ä»Šæ—¥ã®å›ã¯æœ€é«˜ã«å†´ãˆã¦ã‚‹ã‚ˆï¼"
    ].join('\n\n');

    const DEFAULT_CONCIERGE = {
      name: "ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼",
      tips: DEFAULT_TIPS,
      luckyMessages: DEFAULT_LUCKY_MESSAGES,
      states: {
        default: { imageUrl: "../assets/genko55/nomal.png", message: "ä»Šã®ãƒšãƒ¼ã‚¹ã¯ {pace}{unit}/æ—¥ ã ã‚ˆã€‚\nã—ã‚ãã‚Šã¾ã§ã‚ã¨ {days}æ—¥ï¼" },
        good: { imageUrl: "../assets/genko55/good.png", message: "ã„ã„ãƒšãƒ¼ã‚¹ï¼\nã“ã®ã¾ã¾ {pace}{unit}/æ—¥ ã§é€²ã‚ã‚ˆã†ï¼" },
        panic: { imageUrl: "../assets/genko55/pinch.png", message: "ã—ã‚ãã‚Šã¾ã§ ã‚ã¨ {days}æ—¥ï¼\nã¾ã«ã‚ã†ï¼ï¼Ÿ\nå¿…è¦ãªãƒšãƒ¼ã‚¹ã¯ {requiredPace}{unit}/æ—¥ ã ã‚ˆï¼" },
        success: { imageUrl: "../assets/genko55/done.png", message: "è„±ç¨¿ãŠã‚ã§ã¨ã†ï¼ï¼\næœ¬å½“ã«ãŠã¤ã‹ã‚Œã•ã¾ï¼" }
      }
    };

    // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ (State) ---
    let state = {
      user: null,
      loading: true,
      isSaving: false,
      currentView: 'dashboard',
      project: JSON.parse(JSON.stringify(DEFAULT_PROJECT)),
      progress: {},
      concierge: JSON.parse(JSON.stringify(DEFAULT_CONCIERGE)),
      speechState: { type: 'status', text: '' }
    };

    const appDiv = document.getElementById('app');

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»è¨ˆç®— ---
    const escapeHtml = (unsafe) => {
      return (unsafe || '').toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    };

    const getLuckyDayMessage = () => {
      const today = new Date();
      // æ—¥ä»˜ã®ã‚·ãƒ¼ãƒ‰å€¤ã‚’ä½œã‚‹ï¼ˆæ¯æ—¥åŒã˜çµæœã«ã™ã‚‹ãŸã‚ï¼‰
      const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();

      // ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      const luckyRaw = state.concierge.luckyMessages || DEFAULT_LUCKY_MESSAGES;
      const luckyList = luckyRaw.split(/\n\s*\n/).map(t => t.trim()).filter(Boolean);

      if (luckyList.length === 0) return null;

      // 5æ—¥ï¼ˆ25æ—¥ãªã©ï¼‰ã«1å›ã®é »åº¦ã§å‰æ—¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™ç¢ºç‡è¨ˆç®—
      const mod = seed % 25;

      if (mod < luckyList.length) {
        return luckyList[mod];
      }
      return null;
    };

    const processImageFile = (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX_SIZE = 400;
            let width = img.width, height = img.height;
            if (width > height) {
              if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
            } else {
              if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/webp', 0.8));
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    };

    const getStats = () => {
      const parseDate = d => { const dt = new Date(d); dt.setHours(0, 0, 0, 0); return dt; };
      const today = new Date(); today.setHours(0, 0, 0, 0);
      const start = parseDate(state.project.startDate);
      const end = parseDate(state.project.deadline);

      let passedDays = (today - start) / (1000 * 60 * 60 * 24);
      if (passedDays < 1) passedDays = 1;
      const remainingDays = Math.ceil((end - today) / (1000 * 60 * 60 * 24));

      const steps = state.project.type === 'manga' ? MANGA_STEPS : NOVEL_STEPS;
      const totalTasks = steps.length * state.project.totalUnits;
      let currentCompletedTasks = 0;
      steps.forEach(step => { currentCompletedTasks += (state.progress[step.id] || 0); });

      const overallProgressRatio = totalTasks === 0 ? 0 : currentCompletedTasks / totalTasks;
      const completedVirtualUnits = state.project.totalUnits * overallProgressRatio;
      const remainingVirtualUnits = state.project.totalUnits - completedVirtualUnits;

      const currentDailyPace = completedVirtualUnits / passedDays;
      const requiredDailyPaceToFinish = remainingDays > 0 ? remainingVirtualUnits / remainingDays : remainingVirtualUnits;

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®ç›®æ¨™ãƒšãƒ¼ã‚¹ã‚’ã€Œ1æ—¥ã‚ãŸã‚Šã€ã«æ›ç®—
      let userTargetDailyPace = state.project.targetPace || 0;
      if (state.project.targetPacePeriod === 'week') userTargetDailyPace /= 7;
      else if (state.project.targetPacePeriod === 'month') userTargetDailyPace /= 30;

      // ç”»é¢è¡¨ç¤ºç”¨ã®ç¾åœ¨ãƒšãƒ¼ã‚¹ã¨ç›®æ¨™ãƒšãƒ¼ã‚¹ï¼ˆè¨­å®šã•ã‚ŒãŸæœŸé–“ã«åˆã‚ã›ã‚‹ï¼‰
      let displayCurrentPace = currentDailyPace;
      let displayRequiredPace = requiredDailyPaceToFinish;
      let pacePeriodLabel = 'æ—¥';

      if (state.project.targetPacePeriod === 'week') {
        displayCurrentPace = currentDailyPace * 7;
        displayRequiredPace = requiredDailyPaceToFinish * 7;
        pacePeriodLabel = 'é€±';
      } else if (state.project.targetPacePeriod === 'month') {
        displayCurrentPace = currentDailyPace * 30;
        displayRequiredPace = requiredDailyPaceToFinish * 30;
        pacePeriodLabel = 'æœˆ';
      }

      let status = 'default';
      if (remainingVirtualUnits <= 0) status = 'success';
      else if (remainingDays < 0) status = 'panic';
      // ç›®æ¨™ãƒšãƒ¼ã‚¹ã‚’ä¸‹å›ã£ãŸå ´åˆã€ã¾ãŸã¯ã—ã‚ãã‚Šã«å¯¾ã™ã‚‹å¿…è¦ãªãƒšãƒ¼ã‚¹ã«å…¨ãè¶³ã‚Šã¦ã„ãªã„å ´åˆã‚’ãƒ”ãƒ³ãƒã¨ã™ã‚‹
      else if (currentDailyPace < (userTargetDailyPace * 0.7) || requiredDailyPaceToFinish > (currentDailyPace * 1.5)) status = 'panic';
      else if (currentDailyPace >= userTargetDailyPace) status = 'good';

      return {
        remainingDays,
        remainingVirtualUnits,
        currentPace: displayCurrentPace,
        requiredPace: displayRequiredPace, // ç· ã‚åˆ‡ã‚ŠåŸºæº–ã®å¿…è¦ãƒšãƒ¼ã‚¹
        targetPace: state.project.targetPace, // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®ç›®æ¨™ãƒšãƒ¼ã‚¹
        pacePeriodLabel,
        status
      };
    };

    const formatMessage = (msgTemplate, stats) => {
      if (!msgTemplate) return "";
      return msgTemplate
        .replace(/{days}/g, stats.remainingDays)
        .replace(/{pace}/g, stats.currentPace.toFixed(1))
        .replace(/{requiredPace}/g, stats.targetPace) // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã¯è¨­å®šã—ãŸç›®æ¨™ç›®æ¨™ã‚’å„ªå…ˆã™ã‚‹
        .replace(/{unit}/g, state.project.unitName + '/' + stats.pacePeriodLabel)
        .replace(/{remains}/g, stats.remainingVirtualUnits.toFixed(1));
    };

    const updateSpeechStatus = () => {
      const stats = getStats();
      const msg = state.concierge.states[stats.status].message;
      state.speechState = { type: 'status', text: formatMessage(msg, stats) };
    };

    // --- ãƒ‡ãƒ¼ã‚¿ä¿å­˜å‡¦ç† (localStorage) ---
    const saveData = () => {
      state.isSaving = true;
      renderHeaderOnly(); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º

      try {
        const dataToSave = {
          project: state.project,
          progress: state.progress,
          concierge: state.concierge
        };
        localStorage.setItem('genko55_data', JSON.stringify(dataToSave));
      } catch (error) {
        console.error("Save error:", error);
      }

      setTimeout(() => {
        state.isSaving = false;
        renderHeaderOnly(); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¶ˆå»
      }, 300); // ä¿å­˜ã—ãŸã¨ã„ã†ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å°‘ã—ã ã‘è¦‹ã›ã‚‹ãŸã‚ã®é…å»¶
    };

    // --- UI ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
    const renderHeaderOnly = () => {
      const headerDiv = document.getElementById('app-header');
      if (headerDiv) headerDiv.innerHTML = generateHeaderHTML();
      lucide.createIcons();
    };

    const generateHeaderHTML = () => `
      <header class="flex items-center justify-between mb-8 pt-4 sticky top-0 bg-[#fcfbf9]/90 backdrop-blur-sm z-50 py-4">
        <div class="flex items-center gap-2">
          ${state.currentView !== 'dashboard'
        ? `<button data-action="nav" data-view="dashboard" data-save="true" class="p-2 bg-gray-800 text-white rounded-full hover:bg-gray-700 transition-colors shadow-sm flex items-center gap-1 pl-1 pr-3">
                 <i data-lucide="chevron-left" class="w-5 h-5"></i> <span class="text-sm font-bold">ä¿å­˜ã—ã¦æˆ»ã‚‹</span>
               </button>`
        : `<h1 class="text-2xl font-black tracking-tight text-gray-800 truncate max-w-[200px] sm:max-w-[250px]">${escapeHtml(state.project.title)}</h1>`
      }
        </div>
        <div class="flex items-center gap-2">
          ${state.isSaving ? `<i data-lucide="loader-2" class="w-4 h-4 animate-spin text-gray-400"></i>` : ''}
          ${state.currentView === 'dashboard'
        ? `<button data-action="nav" data-view="settings_concierge" class="p-2 bg-white border-2 border-gray-800 rounded-full hover:bg-gray-100 transition-colors shadow-sm">
                 <i data-lucide="user-circle" class="w-5 h-5 text-gray-700"></i>
               </button>
               <button data-action="nav" data-view="settings_project" class="p-2 bg-white border-2 border-gray-800 rounded-full hover:bg-gray-100 transition-colors shadow-sm">
                 <i data-lucide="settings" class="w-5 h-5 text-gray-700"></i>
               </button>`
        : ''
      }
        </div>
      </header>
    `;

    const renderDashboard = () => {
      const stats = getStats();
      const steps = state.project.type === 'manga' ? MANGA_STEPS : NOVEL_STEPS;
      const currentStateConfig = state.concierge.states[stats.status];

      let fallbackIcon = `<i data-lucide="bot" class="w-24 h-24 text-gray-600"></i>`;
      if (stats.status === 'success') fallbackIcon = `<i data-lucide="check-circle-2" class="w-24 h-24 text-pink-500"></i>`;
      else if (stats.status === 'panic') fallbackIcon = `<i data-lucide="alert-triangle" class="w-24 h-24 text-blue-500"></i>`;
      else if (stats.status === 'good') fallbackIcon = `<i data-lucide="sparkles" class="w-24 h-24 text-orange-500"></i>`;

      const checklistHTML = steps.map(step => {
        const currentVal = state.progress[step.id] || 0;
        const maxVal = state.project.totalUnits;
        const isCompleted = currentVal >= maxVal;
        return `
          <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 sm:p-4 border-4 border-gray-800 rounded-2xl transition-colors shadow-sm ${isCompleted ? 'bg-gray-50' : 'bg-white'}">
            <div class="flex items-center gap-3 mb-3 sm:mb-0">
              <button data-action="toggle-complete" data-step="${step.id}" class="w-8 h-8 rounded-lg border-4 border-gray-800 flex items-center justify-center flex-shrink-0 transition-colors hover:scale-105 active:scale-95 ${isCompleted ? 'bg-pink-500 border-pink-500' : 'bg-white hover:bg-gray-100'}">
                ${isCompleted ? `<i data-lucide="check" class="w-[18px] h-[18px] text-white stroke-[4]"></i>` : ''}
              </button>
              <span class="font-bold text-lg sm:text-xl text-gray-800">${escapeHtml(step.name)}</span>
            </div>
            <div class="flex items-center justify-end gap-2 sm:gap-4 font-bold text-lg">
              <button data-action="progress" data-step="${step.id}" data-delta="-1" class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 active:scale-95 transition-transform text-gray-700">
                <i data-lucide="minus" class="w-5 h-5"></i>
              </button>
              <div class="w-24 text-center font-black text-gray-800 tracking-wider">
                ${currentVal} <span class="text-sm text-gray-500 font-bold">/ ${maxVal}</span>
              </div>
              <button data-action="progress" data-step="${step.id}" data-delta="1" class="w-10 h-10 bg-gray-800 text-white rounded-full flex items-center justify-center hover:bg-gray-700 active:scale-95 transition-transform">
                <i data-lucide="plus" class="w-5 h-5"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');

      let progressTextForShare = "";
      steps.forEach(step => {
        const currentVal = state.progress[step.id] || 0;
        progressTextForShare += `${step.name}: ${currentVal}/${state.project.totalUnits}${state.project.unitName}\n`;
      });

      const shareText = encodeURIComponent(`ã€${state.project.title} é€²æ—å ±å‘Šã€‘\nã—ã‚ãã‚Šã¾ã§ã‚ã¨ ${stats.remainingDays > 0 ? stats.remainingDays : 0}æ—¥ï¼\n\n${progressTextForShare}\nä»Šã®ãƒšãƒ¼ã‚¹: ${stats.currentPace.toFixed(1)}${state.project.unitName}/${stats.pacePeriodLabel} (ç›®æ¨™: ${stats.targetPace.toFixed(1)})\n#åŸç¨¿é€²è¡Œã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ `);
      const shareUrl = encodeURIComponent("https://kagetica.net/lab/genko55.html");

      return `
        <div class="space-y-8 pb-10">
          <div data-action="tap-character" class="relative flex flex-col items-center cursor-pointer group select-none">
            <div class="absolute top-0 right-0 sm:right-4 bg-pink-100 text-pink-600 text-xs font-bold px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-20 shadow-sm pointer-events-none">
              ã‚¿ãƒƒãƒ—ã§ãŠã—ã‚ƒã¹ã‚Šâ™ª
            </div>
            <div class="w-full sm:w-11/12 bg-white border-4 border-gray-800 rounded-2xl p-4 sm:p-5 shadow-sm relative mb-2 z-10 transition-all duration-200 hover:scale-[1.02]">
              <div class="absolute left-1/2 -bottom-4 w-0 h-0 border-l-[12px] border-l-transparent border-t-[16px] border-t-gray-800 border-r-[12px] border-r-transparent transform -translate-x-1/2"></div>
              <div class="absolute left-1/2 -bottom-[10px] w-0 h-0 border-l-[9px] border-l-transparent border-t-[12px] border-t-white border-r-[9px] border-r-transparent transform -translate-x-1/2 z-10"></div>
              <p id="speech-text" class="font-bold text-gray-800 whitespace-pre-wrap leading-relaxed text-center text-sm sm:text-base min-h-[3rem] flex items-center justify-center">${escapeHtml(state.speechState.text)}</p>
            </div>
            <div class="w-56 h-64 sm:w-64 sm:h-80 flex items-end justify-center overflow-hidden transition-transform duration-200 group-active:scale-95 group-active:translate-y-2">
              ${(state.speechState.type === 'tip' || state.speechState.type === 'lucky') ?
          (state.concierge.states['default'].imageUrl
            ? `<img src="${escapeHtml(state.concierge.states['default'].imageUrl)}" alt="Concierge" class="max-w-full max-h-full object-contain object-bottom" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div class="hidden w-full h-full flex-col items-center justify-end pb-8 bg-gray-100 rounded-t-[60px] border-4 border-b-0 border-gray-800">${fallbackIcon}</div>`
            : `<div class="w-full h-full flex flex-col items-center justify-end pb-8 bg-gray-100 rounded-t-[60px] border-4 border-b-0 border-gray-800">${fallbackIcon}</div>`)
          : (currentStateConfig.imageUrl
            ? `<img src="${escapeHtml(currentStateConfig.imageUrl)}" alt="Concierge" class="max-w-full max-h-full object-contain object-bottom" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div class="hidden w-full h-full flex-col items-center justify-end pb-8 bg-gray-100 rounded-t-[60px] border-4 border-b-0 border-gray-800">${fallbackIcon}</div>`
            : `<div class="w-full h-full flex flex-col items-center justify-end pb-8 bg-gray-100 rounded-t-[60px] border-4 border-b-0 border-gray-800">${fallbackIcon}</div>`)
        }
            </div>
          </div>

          <!-- è‡ªå‹•è¨ˆç®—ãƒ»é€²æ—è©•ä¾¡ã‚¨ãƒªã‚¢ -->
          <div class="bg-gray-50 border-4 border-gray-800 rounded-2xl p-4 sm:p-5 shadow-sm text-gray-800">
            <h3 class="font-black text-lg mb-2 flex items-center gap-2">
              <i data-lucide="activity" class="w-5 h-5"></i> é€²æ—ãƒ¬ãƒãƒ¼ãƒˆ
            </h3>
            <p class="font-bold text-sm sm:text-base leading-relaxed">
              ${stats.status === 'success'
          ? `è„±ç¨¿ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã™ã¹ã¦ã®ä½œæ¥­ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`
          : stats.status === 'panic'
            ? `ç¾åœ¨ã®ãƒšãƒ¼ã‚¹ã¯ <span class="text-pink-600 font-black text-lg">${stats.currentPace.toFixed(1)}</span> ${state.project.unitName} / ${stats.pacePeriodLabel} ã§ã™ã€‚<br/>ç›®æ¨™ã® <span class="text-blue-600 font-black text-lg">${stats.targetPace}</span> ${state.project.unitName} ã‚ã‚‹ã„ã¯ã€ã—ã‚ãã‚Šã«é–“ã«åˆã‚ã›ã‚‹ãŸã‚ã® <span class="text-blue-600 font-black text-lg">${stats.requiredPace.toFixed(1)}</span> ${state.project.unitName} ã«å±Šã„ã¦ã„ã¾ã›ã‚“ï¼å°‘ã—é ‘å¼µã‚Šã©ã“ã‚ã§ã™ï¼`
            : `ç¾åœ¨ã®ãƒšãƒ¼ã‚¹ã¯ <span class="text-pink-600 font-black text-lg">${stats.currentPace.toFixed(1)}</span> ${state.project.unitName} / ${stats.pacePeriodLabel} ã§é€²è¡Œä¸­ã§ã™ï¼ï¼ˆç›®æ¨™: ${stats.targetPace} ${state.project.unitName}ï¼‰<br/>ã“ã®èª¿å­ã§é€²ã‚ã¾ã—ã‚‡ã†ï¼`
        }
            </p>
          </div>

          <div class="flex gap-4">
            <div class="flex-1 ${stats.remainingDays <= 7 && stats.status !== 'success' ? 'bg-red-50 border-red-500 animate-pulse' : 'bg-white border-gray-800'} border-4 rounded-2xl p-4 text-center shadow-sm transition-colors">
              <div class="text-sm font-bold ${stats.remainingDays <= 7 && stats.status !== 'success' ? 'text-red-500' : 'text-gray-500'} mb-1">
                ${stats.remainingDays <= 7 && stats.status !== 'success' ? 'ğŸš¨ ã—ã‚ãã‚Šã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ ğŸš¨' : 'ã—ã‚ãã‚Šã¾ã§'}
              </div>
              <div class="text-2xl sm:text-3xl font-black ${stats.remainingDays <= 7 && stats.status !== 'success' ? 'text-red-600 font-mono tracking-widest' : 'text-gray-800'}">
                ã‚ã¨ <span class="${stats.remainingDays <= 7 && stats.status !== 'success' ? 'text-4xl' : ''}">${stats.remainingDays > 0 ? stats.remainingDays : 0}</span> <span class="text-lg">æ—¥</span>
              </div>
            </div>
            <div class="flex-1 bg-white border-4 border-gray-800 rounded-2xl p-4 text-center shadow-sm">
              <div class="text-sm font-bold text-gray-500 mb-1">å…¨ä½“ã®ã®ã“ã‚Š</div>
              <div class="text-2xl sm:text-3xl font-black text-gray-800">
                ${Math.max(0, stats.remainingVirtualUnits).toFixed(0)} <span class="text-lg">${escapeHtml(state.project.unitName)}ç›¸å½“</span>
              </div>
            </div>
          </div>

          <div>
            <h2 class="text-xl font-black text-gray-800 mb-4 flex items-center gap-2">
              <i data-lucide="check-circle-2"></i> ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
            </h2>
            <div class="space-y-3">${checklistHTML}</div>
          </div>

          <div class="mt-8 pt-6 border-t-2 border-dashed border-gray-300">
            <a href="https://twitter.com/intent/tweet?text=${shareText}&url=${shareUrl}" target="_blank" rel="noopener noreferrer" class="w-full flex justify-center items-center gap-2 bg-black text-white font-bold py-3 px-6 rounded-xl hover:bg-gray-800 transition-colors shadow-sm">
              <svg viewBox="0 0 24 24" aria-hidden="true" class="w-5 h-5 fill-current"><g><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></g></svg>
              é€²æ—ã‚’X(Twitter)ã§å ±å‘Šã™ã‚‹
            </a>
          </div>

          <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‹Ÿé›† -->
          <div class="mt-8 bg-pink-50 border-4 border-pink-200 rounded-2xl p-5 sm:p-6 text-gray-800 shadow-sm relative overflow-hidden">
            <div class="absolute -right-4 -top-4 w-16 h-16 bg-pink-200 rounded-full opacity-50"></div>
            <div class="absolute -left-2 -bottom-4 w-20 h-20 bg-pink-200 rounded-full opacity-30"></div>
            <h3 class="font-black text-xl mb-3 flex items-center gap-2 text-pink-600 relative z-10">
              <i data-lucide="palette" class="w-6 h-6"></i> ãƒ—ãƒªã‚»ãƒƒãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å‹Ÿé›†ä¸­ï¼
            </h3>
            <p class="font-bold text-sm leading-relaxed mb-4 relative z-10">
              åŸç¨¿é€²è¡Œã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ã®ã€Œãƒ—ãƒªã‚»ãƒƒãƒˆç”»åƒã€ã¨ã—ã¦ã€ã¿ã‚“ãªãŒåˆæœŸè¨­å®šã§é¸ã¹ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æã„ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ
            </p>
            <div class="bg-white rounded-xl p-4 border-2 border-pink-100 font-bold text-sm relative z-10">
              <div class="space-y-3">
                <div class="flex items-start gap-2">
                  <i data-lucide="check" class="w-4 h-4 text-pink-500 mt-0.5 flex-shrink-0"></i>
                  <p>å¿…è¦ãªç”»åƒ: <strong>é€šå¸¸æ™‚ã€é †èª¿ãªæ™‚ã€ãƒ”ãƒ³ãƒã®æ™‚ã€å®Œäº†æ™‚</strong>ã®4ãƒ‘ã‚¿ãƒ¼ãƒ³</p>
                </div>
                <div class="flex items-start gap-2">
                  <i data-lucide="check" class="w-4 h-4 text-pink-500 mt-0.5 flex-shrink-0"></i>
                  <p>ã‚µã‚¤ã‚º: <strong>æ¨ªãƒ»ç¸¦ 1024px ã®æ­£æ–¹å½¢</strong> (äººç‰©ã¯ãƒã‚¹ãƒˆã‚¢ãƒƒãƒ—)ã€èƒŒæ™¯é€é</p>
                </div>
                <div class="flex items-start gap-2">
                  <i data-lucide="check" class="w-4 h-4 text-pink-500 mt-0.5 flex-shrink-0"></i>
                  <p>ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ¡ä»¶: CC BYãƒ©ã‚¤ã‚»ãƒ³ã‚¹ï¼ˆã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¡¨è¨˜ã§èª°ã§ã‚‚åˆ©ç”¨å¯èƒ½ï¼‰ã¨ã—ã¦æä¾›ã—ã¦ã„ãŸã ã‘ã‚‹æ–¹</p>
                </div>
                <div class="flex items-start gap-2">
                  <i data-lucide="check" class="w-4 h-4 text-pink-500 mt-0.5 flex-shrink-0"></i>
                  <p>ç‰¹å…¸: ã‚¢ãƒ—ãƒªå†…ã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆç”»é¢ã«ãŠåå‰ãŒå¸¸æ™‚æ²è¼‰ã•ã‚Œã¾ã™ï¼</p>
                </div>
              </div>
              <div class="mt-5 pt-4 border-t-2 border-dashed border-gray-100 text-center">
                <a href="https://x.com/kagetica" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center gap-1.5 bg-gray-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors text-xs sm:text-sm">
                  <svg viewBox="0 0 24 24" aria-hidden="true" class="w-4 h-4 fill-current"><g><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></g></svg>
                  X (Twitter) ã®DMã§ã”å¿œå‹Ÿã¯ã“ã¡ã‚‰
                </a>
              </div>
            </div>
          </div>
        </div>
      `;
    };

    const renderProjectSettings = () => {
      return `
        <div class="space-y-6 bg-white p-6 rounded-2xl border-4 border-gray-800 shadow-sm">
          <h2 class="text-xl font-black text-gray-800 flex items-center gap-2 mb-6">
            <i data-lucide="settings"></i> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
          </h2>
          <div class="space-y-4">
            <div>
              <label class="block font-bold text-gray-700 mb-2">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå</label>
              <input type="text" data-bind="project.title" value="${escapeHtml(state.project.title)}" class="w-full p-3 border-4 border-gray-800 rounded-xl font-bold focus:outline-none focus:border-pink-500" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block font-bold text-gray-700 mb-2">ç¨®é¡</label>
                <select data-bind="project.type" class="w-full p-3 border-4 border-gray-800 rounded-xl font-bold focus:outline-none focus:border-pink-500 appearance-none bg-white">
                  <option value="manga" ${state.project.type === 'manga' ? 'selected' : ''}>æ¼«ç”»</option>
                  <option value="novel" ${state.project.type === 'novel' ? 'selected' : ''}>å°èª¬</option>
                </select>
              </div>
              <div>
                <label class="block font-bold text-gray-700 mb-2">å˜ä½ (Pãªã©)</label>
                <input type="text" data-bind="project.unitName" value="${escapeHtml(state.project.unitName)}" class="w-full p-3 border-4 border-gray-800 rounded-xl font-bold focus:outline-none focus:border-pink-500" />
              </div>
            </div>
            <div>
              <label class="block font-bold text-gray-700 mb-2">å…¨ä½“ã®é‡ (ç·ãƒšãƒ¼ã‚¸æ•°ãªã©)</label>
              <input type="number" data-bind="project.totalUnits" value="${state.project.totalUnits}" class="w-full p-3 border-4 border-gray-800 rounded-xl font-bold focus:outline-none focus:border-pink-500" min="1" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block font-bold text-gray-700 mb-2">é–‹å§‹æ—¥</label>
                <input type="date" data-bind="project.startDate" value="${escapeHtml(state.project.startDate)}" class="w-full p-3 border-4 border-gray-800 rounded-xl font-bold focus:outline-none focus:border-pink-500" />
              </div>
              <div>
                <label class="block font-bold text-gray-700 mb-2">ã—ã‚ãã‚Šæ—¥</label>
                <input type="date" data-bind="project.deadline" value="${escapeHtml(state.project.deadline)}" class="w-full p-3 border-4 border-gray-800 rounded-xl font-bold focus:outline-none focus:border-pink-500" />
              </div>
            </div>
            <div class="bg-gray-50 border-2 border-gray-200 p-4 rounded-xl mt-4">
              <label class="block font-bold text-gray-800 mb-3"><i data-lucide="target" class="w-4 h-4 inline-block mr-1"></i>ç›®æ¨™ãƒšãƒ¼ã‚¹ã®è¨­å®š</label>
              <div class="flex items-center gap-3">
                <select data-bind="project.targetPacePeriod" class="p-3 border-4 border-gray-800 rounded-xl font-bold focus:outline-none focus:border-pink-500 appearance-none bg-white w-24 sm:w-32">
                  <option value="day" ${state.project.targetPacePeriod === 'day' ? 'selected' : ''}>1æ—¥</option>
                  <option value="week" ${state.project.targetPacePeriod === 'week' ? 'selected' : ''}>1é€±é–“</option>
                  <option value="month" ${state.project.targetPacePeriod === 'month' ? 'selected' : ''}>1ãƒ¶æœˆ</option>
                </select>
                <span class="font-bold text-gray-600">ã‚ãŸã‚Š</span>
                <input type="number" data-bind="project.targetPace" value="${state.project.targetPace || 1}" class="w-20 sm:w-24 p-3 border-4 border-gray-800 rounded-xl font-bold focus:outline-none focus:border-pink-500 text-center" min="0.1" step="0.1" />
                <span class="font-bold text-gray-600">${escapeHtml(state.project.unitName || 'P')}</span>
              </div>
              <p class="text-xs text-gray-500 font-bold mt-2">â€»ã“ã®ç›®æ¨™ãƒšãƒ¼ã‚¹ã‚’ä¸‹å›ã‚‹ã¨ã€ã‚­ãƒ£ãƒ©ãŒã€Œãƒ”ãƒ³ãƒã®æ™‚ã€ã®ç”»åƒã«ãªã‚Šã¾ã™ã€‚</p>
            </div>
          </div>
        </div>
      `;
    };

    const renderConciergeSettings = () => {
      const stateLabels = {
        default: { label: "é€šå¸¸æ™‚", color: "text-gray-600" },
        good: { label: "é †èª¿ãªæ™‚", color: "text-orange-500" },
        panic: { label: "ãƒ”ãƒ³ãƒã®æ™‚", color: "text-blue-500" },
        success: { label: "å®Œäº†æ™‚", color: "text-pink-500" }
      };

      const statesHTML = Object.entries(state.concierge.states).map(([stateKey, stateData]) => `
        <div class="border-l-4 pl-4 border-gray-800">
          <h3 class="font-black text-lg mb-3 ${stateLabels[stateKey].color}">${stateLabels[stateKey].label}</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-1">
                <i data-lucide="image" class="w-4 h-4"></i> ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒ
              </label>
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <input type="file" accept="image/*" id="file-${stateKey}" data-action="upload-image" data-state-key="${stateKey}" class="hidden" />
                  <label for="file-${stateKey}" class="cursor-pointer bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                    <i data-lucide="upload" class="w-4 h-4"></i> ç”»åƒã‚’é¸æŠ
                  </label>
                  ${stateData.imageUrl && stateData.imageUrl !== DEFAULT_CONCIERGE.states[stateKey].imageUrl ?
          `<button data-action="reset-image" data-state-key="${stateKey}" class="cursor-pointer bg-white border border-red-300 hover:bg-red-50 text-red-600 text-sm font-bold py-1.5 px-3 rounded-lg transition-colors flex items-center gap-1">
                      <i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
                    </button>`
          : ''}
                </div>
                <div class="flex items-center gap-2 text-sm">
                  <span class="text-gray-500 font-bold text-xs w-10 text-center">ã¾ãŸã¯</span>
                  <input type="text" data-bind="concierge.states.${stateKey}.imageUrl" value="${escapeHtml(stateData.imageUrl)}" placeholder="https://... (ç”»åƒURL)" class="flex-1 p-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-gray-800 text-sm" />
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-1">ã‚»ãƒªãƒ•</label>
              <textarea data-bind="concierge.states.${stateKey}.message" rows="3" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-gray-800 text-sm font-bold">${escapeHtml(stateData.message)}</textarea>
            </div>
          </div>
        </div>
      `).join('');

      return `
        <div class="space-y-6 bg-white p-6 rounded-2xl border-4 border-gray-800 shadow-sm">
          <h2 class="text-xl font-black text-gray-800 flex items-center gap-2 mb-6">
            <i data-lucide="user-circle"></i> ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥è¨­å®š
          </h2>
          
          <div class="mb-8 p-4 bg-pink-50 rounded-xl border-2 border-pink-200">
            <h3 class="font-black text-lg mb-2 text-pink-700 flex items-center gap-2">
              <i data-lucide="message-square" class="w-5 h-5"></i> ã‚¿ãƒƒãƒ—ã—ãŸæ™‚ã®ãŠã—ã‚ƒã¹ã‚Š
            </h3>
            <p class="text-xs font-bold text-pink-600 mb-2">â€»ç©ºè¡Œï¼ˆ1è¡Œã‚ã‘ã‚‹ï¼‰ã§åˆ¥ã®ã‚»ãƒªãƒ•ã¨ã—ã¦åˆ†ã‹ã‚Œã¾ã™ã€‚</p>
            <textarea data-bind="concierge.tips" rows="6" placeholder="ã“ã¾ã‚ã«ä¿å­˜ã—ã‚ˆã†ï¼&#13;&#10;&#13;&#10;ä¼‘æ†©ã‚‚å¤§äº‹ã ã‚ˆï¼" class="w-full p-3 border-2 border-pink-300 rounded-lg focus:outline-none focus:border-pink-500 text-sm font-bold bg-white">${escapeHtml(state.concierge.tips)}</textarea>
          </div>

          <p class="text-sm font-bold text-gray-600 mb-6 bg-gray-100 p-4 rounded-xl leading-relaxed">
            ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€URLã‚’å…¥åŠ›ã™ã‚‹ã¨ã‚­ãƒ£ãƒ©ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚<br/>
            <span class="text-pink-600">â–  æ¨å¥¨ã‚µã‚¤ã‚º:</span> ç¸¦æ¨ª400pxã€œ600pxç¨‹åº¦<br/>
            â€»å¤§ãã„ç”»åƒã§ã‚‚è‡ªå‹•ã§è»½ã„ã‚µã‚¤ã‚ºã«ç¸®å°ã•ã‚Œã¾ã™ã€‚<br/>
            <span class="text-pink-600">{days}</span> : æ®‹ã‚Šæ—¥æ•° / 
            <span class="text-pink-600">{pace}</span> : ä»Šã®ãƒšãƒ¼ã‚¹ / 
            <span class="text-pink-600">{requiredPace}</span> : ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã—ãŸç›®æ¨™ãƒšãƒ¼ã‚¹ / 
            <span class="text-pink-600">{unit}</span> : P/é€± ãªã©ã®å˜ä½ã‚»ãƒƒãƒˆ
          </p>

          <div class="space-y-8">${statesHTML}</div>

          <div class="mt-8 p-4 bg-purple-50 rounded-xl border-2 border-purple-200">
            <h3 class="font-black text-lg mb-2 text-purple-700 flex items-center gap-2">
              <i data-lucide="sparkles" class="w-5 h-5"></i> å‰æ—¥ãƒ»å ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            </h3>
            <p class="text-xs font-bold text-purple-600 mb-2">â€»è¤‡æ•°ç™»éŒ²ã™ã‚‹ã¨ã€ãŸã¾ã«ä»Šæ—¥ã®é‹å‹¢ã¨ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            <p class="text-xs font-bold text-purple-600 mb-3">â€»è¡¨ç¤ºã•ã‚Œã‚‹æ™‚ã®è¡¨æƒ…ã¯ã€Œé€šå¸¸æ™‚ã€ã®ç”»åƒã«ãªã‚Šã¾ã™ã€‚</p>
            <textarea data-bind="concierge.luckyMessages" rows="6" placeholder="ä»Šæ—¥ã¯æœ€é«˜ã®ä½œæ¥­æ—¥å’Œï¼&#13;&#10;&#13;&#10;ä»Šæ—¥ã¯æ¨ã—ã‚«ãƒ—è¨˜å¿µæ—¥ï¼æ°—åˆå…¥ã‚Œã¦ã„ã“ã†ï¼" class="w-full p-3 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-purple-500 text-sm font-bold bg-white leading-relaxed">${escapeHtml(state.concierge.luckyMessages || DEFAULT_LUCKY_MESSAGES)}</textarea>
          </div>
        </div>
      `;
    };

    const renderApp = () => {
      if (state.loading) {
        appDiv.innerHTML = `<div class="flex items-center justify-center min-h-[50vh]"><i data-lucide="loader-2" class="animate-spin text-pink-500 w-12 h-12"></i></div>`;
        lucide.createIcons();
        return;
      }

      let contentHTML = '';
      if (state.currentView === 'dashboard') contentHTML = renderDashboard();
      else if (state.currentView === 'settings_project') contentHTML = renderProjectSettings();
      else if (state.currentView === 'settings_concierge') contentHTML = renderConciergeSettings();

      appDiv.innerHTML = `<div id="app-header"></div><main>${contentHTML}</main>`;
      renderHeaderOnly();
      lucide.createIcons();
    };

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
    appDiv.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;

      const action = btn.dataset.action;
      if (action === 'nav') {
        if (btn.dataset.save === 'true') {
          saveData();
          updateSpeechStatus(); // ã—ã‚ãã‚Šç­‰ã®è¨­å®šå¤‰æ›´ã‚’ã‚»ãƒªãƒ•ï¼ˆçŠ¶æ…‹ï¼‰ã«å³æ™‚åæ˜ ã•ã›ã‚‹
        }
        state.currentView = btn.dataset.view;
        renderApp();
      }
      else if (action === 'progress') {
        const stepId = btn.dataset.step;
        const delta = Number(btn.dataset.delta);
        const current = state.progress[stepId] || 0;
        state.progress[stepId] = Math.max(0, Math.min(state.project.totalUnits, current + delta));

        updateSpeechStatus();
        saveData(); // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã¯è‡ªå‹•ä¿å­˜
        renderApp();
      }
      else if (action === 'toggle-complete') {
        const stepId = btn.dataset.step;
        const current = state.progress[stepId] || 0;
        const maxVal = state.project.totalUnits;

        // ã™ã§ã«MAXãªã‚‰0ã«ã€ãã‚Œä»¥å¤–ãªã‚‰MAXã«ã™ã‚‹
        if (current >= maxVal) {
          state.progress[stepId] = 0;
        } else {
          state.progress[stepId] = maxVal;
        }

        updateSpeechStatus();
        saveData(); // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã¯è‡ªå‹•ä¿å­˜
        renderApp();
      }
      else if (action === 'tap-character') {
        let tipsList = state.concierge.tips ? state.concierge.tips.split(/\n\s*\n/).map(t => t.trim()).filter(Boolean) : [];
        if (tipsList.length === 0) tipsList = ["ãƒ•ã‚¡ã‚¤ãƒˆãƒ¼ï¼"];

        if (state.speechState.type === 'status') {
          const luckyMsg = getLuckyDayMessage();
          if (luckyMsg) state.speechState = { type: 'lucky', text: luckyMsg };
          else state.speechState = { type: 'tip', text: tipsList[Math.floor(Math.random() * tipsList.length)] };
        } else if (state.speechState.type === 'lucky') {
          state.speechState = { type: 'tip', text: tipsList[Math.floor(Math.random() * tipsList.length)] };
        } else {
          if (Math.random() > 0.5) updateSpeechStatus();
          else state.speechState = { type: 'tip', text: tipsList[Math.floor(Math.random() * tipsList.length)] };
        }

        // stateæ›´æ–°å¾Œã«renderAppã‚’å‘¼ã‚“ã§ç”»åƒã‚’æ›´æ–°ã™ã‚‹
        renderApp();
      }
      else if (action === 'reset-image') {
        const stateKey = btn.dataset.stateKey;
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã‚’å¾©å…ƒ
        state.concierge.states[stateKey].imageUrl = DEFAULT_CONCIERGE.states[stateKey].imageUrl;
        saveData();
        renderApp();
      }
    });

    const handleDataBind = (e) => {
      const bindPath = e.target.dataset.bind;
      if (!bindPath) return;

      const val = e.target.type === 'number' ? Number(e.target.value) : e.target.value;
      const keys = bindPath.split('.');
      let current = state;
      for (let i = 0; i < keys.length - 1; i++) {
        current = current[keys[i]];
      }
      current[keys[keys.length - 1]] = val;

      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã¯é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ
      if (bindPath === 'project.type') {
        state.progress = {};
      }

      // å¤‰æ›´ã‚’è‡ªå‹•ä¿å­˜ï¼ˆå°‘ã—é…å»¶ã•ã›ã¦é€£ç¶šå…¥åŠ›ã‚’ã¾ã¨ã‚ã‚‹ï¼‰
      clearTimeout(window._saveTimer);
      window._saveTimer = setTimeout(() => {
        saveData();
      }, 1000);
    };

    // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚° (å…¥åŠ›æ™‚ã«Stateã‚’è‡ªå‹•æ›´æ–°ã—ã€ä¿å­˜)
    appDiv.addEventListener('input', handleDataBind);
    // selectãªã©ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚‚æ‹¾ã£ã¦ä¿å­˜ã™ã‚‹
    appDiv.addEventListener('change', (e) => {
      if (e.target.dataset.bind) {
        handleDataBind(e);
      }
    });

    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
    appDiv.addEventListener('change', async (e) => {
      if (e.target.matches('[data-action="upload-image"]')) {
        const stateKey = e.target.dataset.stateKey;
        const file = e.target.files[0];
        if (!file) return;
        try {
          const base64Url = await processImageFile(file);
          state.concierge.states[stateKey].imageUrl = base64Url;
          saveData(); // ç”»åƒå¤‰æ›´æ™‚ã«ã™ãä¿å­˜
          renderApp(); // ç”»åƒæ›´æ–°ã®ãŸã‚å†æç”»
        } catch (error) {
          console.error("ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        }
      }
    });

    // --- åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼ (localStorage) ---
    const initApp = () => {
      try {
        const savedDataStr = localStorage.getItem('genko55_data');
        if (savedDataStr) {
          const savedData = JSON.parse(savedDataStr);
          if (savedData.project) state.project = savedData.project;
          if (savedData.progress) state.progress = savedData.progress;
          if (savedData.concierge) state.concierge = { ...DEFAULT_CONCIERGE, ...savedData.concierge };
        }
      } catch (error) {
        console.error("Load error:", error);
      }

      state.loading = false;
      updateSpeechStatus();
      renderApp();
    };

    // ã‚¢ãƒ—ãƒªèµ·å‹•
    initApp();
  </script>
</body>

</html>