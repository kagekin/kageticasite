<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>原稿進行コンシェルジュ</title>
  <meta property="og:title" content="原稿進行コンシェルジュ">
  <meta property="og:description" content="漫画や小説の原稿進捗を管理し、ペースに合わせて励ましてくれるコンシェルジュアプリです。">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://kagetica.net/lab/genko55.html">
  <meta property="og:image" content="https://kagetica.net/assets/genko55/ogp-genko55.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@kagetica">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* カスタムスタイル */
    .selection-pink::selection {
      background-color: #fbcfe8;
    }

    body {
      font-family: sans-serif;
    }

    /* 隠し要素用クラス */
    .d-none {
      display: none !important;
    }
  </style>
</head>

<body class="bg-[#fcfbf9] text-gray-900 selection-pink min-h-screen pb-20">
  <div id="app" class="max-w-md mx-auto p-4 sm:p-6"></div>

  <!-- アプリケーションロジック (localStorage保存版) -->
  <script type="module">
    // --- 定数定義 ---
    const MANGA_STEPS = [
      { id: 'plot', name: 'プロット' },
      { id: 'name', name: 'ネーム' },
      { id: 'draft', name: '下書き' },
      { id: 'pen', name: 'ペン入れ' },
      { id: 'tone', name: 'トーン・仕上' }
    ];

    const NOVEL_STEPS = [
      { id: 'plot', name: 'プロット' },
      { id: 'draft', name: '本文執筆' },
      { id: 'revise', name: '推敲' },
      { id: 'proofread', name: '校正' }
    ];

    const DEFAULT_PROJECT = {
      title: "新刊プロジェクト",
      type: "manga",
      totalUnits: 30,
      unitName: "P",
      startDate: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
    };

    const DEFAULT_TIPS = [
      "こまめに保存（Ctrl+S / Cmd+S）を忘れないでね！\n息をするように保存！",
      "疲れたら15分だけ仮眠をとるとスッキリするよ。\n寝すぎには注意！",
      "水分補給はしっかりね！\nコーヒーやエナジードリンクの飲み過ぎは禁物だよ。",
      "どうしてもやる気が出ない時は、\nとりあえず机に向かって1分だけ作業してみよう！",
      "手首や肩のストレッチをしておこう！\n体が資本だからね！"
    ].join("\n\n");

    const DEFAULT_CONCIERGE = {
      name: "ナビゲーター",
      tips: DEFAULT_TIPS,
      states: {
        default: { imageUrl: "../assets/genko55/nomal.png", message: "今のペースは {pace}{unit}/日 だよ。\nしめきりまであと {days}日！" },
        good: { imageUrl: "../assets/genko55/good.png", message: "いいペース！\nこのまま {pace}{unit}/日 で進めよう！" },
        panic: { imageUrl: "../assets/genko55/pinch.png", message: "しめきりまで あと {days}日！\nまにあう！？\n必要なペースは {requiredPace}{unit}/日 だよ！" },
        success: { imageUrl: "../assets/genko55/done.png", message: "脱稿おめでとう！！\n本当におつかれさま！" }
      }
    };

    // --- アプリケーション状態 (State) ---
    let state = {
      user: null,
      loading: true,
      isSaving: false,
      currentView: 'dashboard',
      project: JSON.parse(JSON.stringify(DEFAULT_PROJECT)),
      progress: {},
      concierge: JSON.parse(JSON.stringify(DEFAULT_CONCIERGE)),
      speechState: { type: 'status', text: '' }
    };

    const appDiv = document.getElementById('app');

    // --- ユーティリティ・計算 ---
    const escapeHtml = (unsafe) => {
      return (unsafe || '').toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    };

    const getLuckyDayMessage = () => {
      const today = new Date();
      const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
      const mod = seed % 25;
      switch (mod) {
        case 0: return "今日は『一粒万倍日』！\n新しい作業を始めるのに最強の日だよ！";
        case 1: return "今日は『天赦日』！\nつまずいていたシーンを一気に進めるチャンス！";
        case 2: return "今日は『大安』！\n何事もうまくいく日！作業がサクサクはかどるかも！";
        case 3: return "今日は『寅の日』！\n資料や素材を買うなら今日がおすすめ！";
        case 4: return "今日は『己巳の日』！\n芸術の女神の縁日！今日の君は最高に冴えてるよ！";
        default: return null;
      }
    };

    const processImageFile = (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX_SIZE = 400;
            let width = img.width, height = img.height;
            if (width > height) {
              if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
            } else {
              if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/webp', 0.8));
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    };

    const getStats = () => {
      const parseDate = d => { const dt = new Date(d); dt.setHours(0, 0, 0, 0); return dt; };
      const today = new Date(); today.setHours(0, 0, 0, 0);
      const start = parseDate(state.project.startDate);
      const end = parseDate(state.project.deadline);

      let passedDays = (today - start) / (1000 * 60 * 60 * 24);
      if (passedDays < 1) passedDays = 1;
      const remainingDays = Math.ceil((end - today) / (1000 * 60 * 60 * 24));

      const steps = state.project.type === 'manga' ? MANGA_STEPS : NOVEL_STEPS;
      const totalTasks = steps.length * state.project.totalUnits;
      let currentCompletedTasks = 0;
      steps.forEach(step => { currentCompletedTasks += (state.progress[step.id] || 0); });

      const overallProgressRatio = totalTasks === 0 ? 0 : currentCompletedTasks / totalTasks;
      const completedVirtualUnits = state.project.totalUnits * overallProgressRatio;
      const remainingVirtualUnits = state.project.totalUnits - completedVirtualUnits;

      const currentPace = completedVirtualUnits / passedDays;
      const requiredPace = remainingDays > 0 ? remainingVirtualUnits / remainingDays : remainingVirtualUnits;

      let status = 'default';
      if (remainingVirtualUnits <= 0) status = 'success';
      else if (remainingDays < 0) status = 'panic';
      else if (remainingDays <= 3 || requiredPace > currentPace * 1.5) status = 'panic';
      else if (currentPace >= requiredPace) status = 'good';

      return { remainingDays, remainingVirtualUnits, currentPace, requiredPace, status };
    };

    const formatMessage = (msgTemplate, stats) => {
      if (!msgTemplate) return "";
      return msgTemplate
        .replace(/{days}/g, stats.remainingDays)
        .replace(/{pace}/g, stats.currentPace.toFixed(1))
        .replace(/{requiredPace}/g, stats.requiredPace.toFixed(1))
        .replace(/{unit}/g, state.project.unitName)
        .replace(/{remains}/g, stats.remainingVirtualUnits.toFixed(1));
    };

    const updateSpeechStatus = () => {
      const stats = getStats();
      const msg = state.concierge.states[stats.status].message;
      state.speechState = { type: 'status', text: formatMessage(msg, stats) };
    };

    // --- データ保存処理 (localStorage) ---
    const saveData = () => {
      state.isSaving = true;
      renderHeaderOnly(); // ローディング表示

      try {
        const dataToSave = {
          project: state.project,
          progress: state.progress,
          concierge: state.concierge
        };
        localStorage.setItem('genko55_data', JSON.stringify(dataToSave));
      } catch (error) {
        console.error("Save error:", error);
      }

      setTimeout(() => {
        state.isSaving = false;
        renderHeaderOnly(); // ローディング消去
      }, 300); // 保存したというフィードバックを少しだけ見せるための遅延
    };

    // --- UI レンダリング ---
    const renderHeaderOnly = () => {
      const headerDiv = document.getElementById('app-header');
      if (headerDiv) headerDiv.innerHTML = generateHeaderHTML();
      lucide.createIcons();
    };

    const generateHeaderHTML = () => `
      <header class="flex items-center justify-between mb-8 pt-4 sticky top-0 bg-[#fcfbf9]/90 backdrop-blur-sm z-50 py-4">
        <div class="flex items-center gap-2">
          ${state.currentView !== 'dashboard'
        ? `<button data-action="nav" data-view="dashboard" data-save="true" class="p-2 bg-gray-800 text-white rounded-full hover:bg-gray-700 transition-colors shadow-sm flex items-center gap-1 pl-1 pr-3">
                 <i data-lucide="chevron-left" class="w-5 h-5"></i> <span class="text-sm font-bold">保存して戻る</span>
               </button>`
        : `<h1 class="text-2xl font-black tracking-tight text-gray-800 truncate max-w-[200px] sm:max-w-[250px]">${escapeHtml(state.project.title)}</h1>`
      }
        </div>
        <div class="flex items-center gap-2">
          ${state.isSaving ? `<i data-lucide="loader-2" class="w-4 h-4 animate-spin text-gray-400"></i>` : ''}
          ${state.currentView === 'dashboard'
        ? `<button data-action="nav" data-view="settings_concierge" class="p-2 bg-white border-2 border-gray-800 rounded-full hover:bg-gray-100 transition-colors shadow-sm">
                 <i data-lucide="user-circle" class="w-5 h-5 text-gray-700"></i>
               </button>
               <button data-action="nav" data-view="settings_project" class="p-2 bg-white border-2 border-gray-800 rounded-full hover:bg-gray-100 transition-colors shadow-sm">
                 <i data-lucide="settings" class="w-5 h-5 text-gray-700"></i>
               </button>`
        : ''
      }
        </div>
      </header>
    `;

    const renderDashboard = () => {
      const stats = getStats();
      const steps = state.project.type === 'manga' ? MANGA_STEPS : NOVEL_STEPS;
      const currentStateConfig = state.concierge.states[stats.status];

      let fallbackIcon = `<i data-lucide="bot" class="w-24 h-24 text-gray-600"></i>`;
      if (stats.status === 'success') fallbackIcon = `<i data-lucide="check-circle-2" class="w-24 h-24 text-pink-500"></i>`;
      else if (stats.status === 'panic') fallbackIcon = `<i data-lucide="alert-triangle" class="w-24 h-24 text-blue-500"></i>`;
      else if (stats.status === 'good') fallbackIcon = `<i data-lucide="sparkles" class="w-24 h-24 text-orange-500"></i>`;

      const checklistHTML = steps.map(step => {
        const currentVal = state.progress[step.id] || 0;
        const maxVal = state.project.totalUnits;
        const isCompleted = currentVal >= maxVal;
        return `
          <div class="flex flex-col sm:flex-row sm:items-center justify-between p-3 sm:p-4 border-4 border-gray-800 rounded-2xl transition-colors shadow-sm ${isCompleted ? 'bg-gray-50' : 'bg-white'}">
            <div class="flex items-center gap-3 mb-3 sm:mb-0">
              <div class="w-8 h-8 rounded-lg border-4 border-gray-800 flex items-center justify-center flex-shrink-0 transition-colors ${isCompleted ? 'bg-pink-500 border-pink-500' : 'bg-white'}">
                ${isCompleted ? `<i data-lucide="check" class="w-[18px] h-[18px] text-white stroke-[4]"></i>` : ''}
              </div>
              <span class="font-bold text-lg sm:text-xl text-gray-800">${escapeHtml(step.name)}</span>
            </div>
            <div class="flex items-center justify-end gap-2 sm:gap-4 font-bold text-lg">
              <button data-action="progress" data-step="${step.id}" data-delta="-1" class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 active:scale-95 transition-transform text-gray-700">
                <i data-lucide="minus" class="w-5 h-5"></i>
              </button>
              <div class="w-24 text-center font-black text-gray-800 tracking-wider">
                ${currentVal} <span class="text-sm text-gray-500 font-bold">/ ${maxVal}</span>
              </div>
              <button data-action="progress" data-step="${step.id}" data-delta="1" class="w-10 h-10 bg-gray-800 text-white rounded-full flex items-center justify-center hover:bg-gray-700 active:scale-95 transition-transform">
                <i data-lucide="plus" class="w-5 h-5"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');

      let progressTextForShare = "";
      steps.forEach(step => {
        const currentVal = state.progress[step.id] || 0;
        progressTextForShare += `${step.name}: ${currentVal}/${state.project.totalUnits}${state.project.unitName}\n`;
      });

      const shareText = encodeURIComponent(`【${state.project.title} 進捗報告】\nしめきりまであと ${stats.remainingDays > 0 ? stats.remainingDays : 0}日！\n\n${progressTextForShare}\n今のペース: ${stats.currentPace.toFixed(1)}${state.project.unitName}/日\n#原稿進行コンシェルジュ `);
      const shareUrl = encodeURIComponent("https://kagetica.net/lab/genko55.html");

      return `
        <div class="space-y-8 pb-10">
          <div data-action="tap-character" class="relative flex flex-col items-center cursor-pointer group select-none">
            <div class="absolute top-0 right-0 sm:right-4 bg-pink-100 text-pink-600 text-xs font-bold px-3 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-20 shadow-sm pointer-events-none">
              タップでおしゃべり♪
            </div>
            <div class="w-full sm:w-11/12 bg-white border-4 border-gray-800 rounded-2xl p-4 sm:p-5 shadow-sm relative mb-2 z-10 transition-all duration-200 hover:scale-[1.02]">
              <div class="absolute left-1/2 -bottom-4 w-0 h-0 border-l-[12px] border-l-transparent border-t-[16px] border-t-gray-800 border-r-[12px] border-r-transparent transform -translate-x-1/2"></div>
              <div class="absolute left-1/2 -bottom-[10px] w-0 h-0 border-l-[9px] border-l-transparent border-t-[12px] border-t-white border-r-[9px] border-r-transparent transform -translate-x-1/2 z-10"></div>
              <p id="speech-text" class="font-bold text-gray-800 whitespace-pre-wrap leading-relaxed text-center text-sm sm:text-base min-h-[3rem] flex items-center justify-center">${escapeHtml(state.speechState.text)}</p>
            </div>
            <div class="w-56 h-64 sm:w-64 sm:h-80 flex items-end justify-center overflow-hidden transition-transform duration-200 group-active:scale-95 group-active:translate-y-2">
              ${(state.speechState.type === 'tip' || state.speechState.type === 'lucky') ?
          (state.concierge.states['default'].imageUrl
            ? `<img src="${escapeHtml(state.concierge.states['default'].imageUrl)}" alt="Concierge" class="max-w-full max-h-full object-contain object-bottom" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div class="hidden w-full h-full flex-col items-center justify-end pb-8 bg-gray-100 rounded-t-[60px] border-4 border-b-0 border-gray-800">${fallbackIcon}</div>`
            : `<div class="w-full h-full flex flex-col items-center justify-end pb-8 bg-gray-100 rounded-t-[60px] border-4 border-b-0 border-gray-800">${fallbackIcon}</div>`)
          : (currentStateConfig.imageUrl
            ? `<img src="${escapeHtml(currentStateConfig.imageUrl)}" alt="Concierge" class="max-w-full max-h-full object-contain object-bottom" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div class="hidden w-full h-full flex-col items-center justify-end pb-8 bg-gray-100 rounded-t-[60px] border-4 border-b-0 border-gray-800">${fallbackIcon}</div>`
            : `<div class="w-full h-full flex flex-col items-center justify-end pb-8 bg-gray-100 rounded-t-[60px] border-4 border-b-0 border-gray-800">${fallbackIcon}</div>`)
        }
            </div>
          </div>

          <!-- 自動計算・進捗評価エリア -->
          <div class="bg-gray-50 border-4 border-gray-800 rounded-2xl p-4 sm:p-5 shadow-sm text-gray-800">
            <h3 class="font-black text-lg mb-2 flex items-center gap-2">
              <i data-lucide="activity" class="w-5 h-5"></i> 進捗レポート
            </h3>
            <p class="font-bold text-sm sm:text-base leading-relaxed">
              ${stats.status === 'success'
          ? `脱稿おめでとうございます！すべての作業が完了しました。`
          : stats.status === 'panic'
            ? `現在のペースは <span class="text-pink-600 font-black text-lg">${stats.currentPace.toFixed(1)}</span> ${state.project.unitName}/日 ですが、<br/>しめきりに間に合わせるには <span class="text-blue-600 font-black text-lg">${stats.requiredPace.toFixed(1)}</span> ${state.project.unitName}/日 のペースが必要です！少し頑張りどころです！`
            : `現在のペースは <span class="text-pink-600 font-black text-lg">${stats.currentPace.toFixed(1)}</span> ${state.project.unitName}/日 で進行中です！<br/>（目標ペース: ${stats.requiredPace.toFixed(1)} ${state.project.unitName}/日）この調子で進めましょう！`
        }
            </p>
          </div>

          <div class="flex gap-4">
            <div class="flex-1 bg-white border-4 border-gray-800 rounded-2xl p-4 text-center shadow-sm">
              <div class="text-sm font-bold text-gray-500 mb-1">しめきりまで</div>
              <div class="text-2xl sm:text-3xl font-black text-gray-800">
                あと ${stats.remainingDays > 0 ? stats.remainingDays : 0} <span class="text-lg">日</span>
              </div>
            </div>
            <div class="flex-1 bg-white border-4 border-gray-800 rounded-2xl p-4 text-center shadow-sm">
              <div class="text-sm font-bold text-gray-500 mb-1">全体ののこり</div>
              <div class="text-2xl sm:text-3xl font-black text-gray-800">
                ${Math.max(0, stats.remainingVirtualUnits).toFixed(0)} <span class="text-lg">${escapeHtml(state.project.unitName)}相当</span>
              </div>
            </div>
          </div>

          <div>
            <h2 class="text-xl font-black text-gray-800 mb-4 flex items-center gap-2">
              <i data-lucide="check-circle-2"></i> チェックリスト
            </h2>
            <div class="space-y-3">${checklistHTML}</div>
          </div>

          <div class="mt-8 pt-6 border-t-2 border-dashed border-gray-300">
            <a href="https://twitter.com/intent/tweet?text=${shareText}&url=${shareUrl}" target="_blank" rel="noopener noreferrer" class="w-full flex justify-center items-center gap-2 bg-black text-white font-bold py-3 px-6 rounded-xl hover:bg-gray-800 transition-colors shadow-sm">
              <svg viewBox="0 0 24 24" aria-hidden="true" class="w-5 h-5 fill-current"><g><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></g></svg>
              進捗をX(Twitter)で報告する
            </a>
          </div>
        </div>
      `;
    };

    const renderProjectSettings = () => {
      return `
        <div class="space-y-6 bg-white p-6 rounded-2xl border-4 border-gray-800 shadow-sm">
          <h2 class="text-xl font-black text-gray-800 flex items-center gap-2 mb-6">
            <i data-lucide="settings"></i> プロジェクト設定
          </h2>
          <div class="space-y-4">
            <div>
              <label class="block font-bold text-gray-700 mb-2">プロジェクト名</label>
              <input type="text" data-bind="project.title" value="${escapeHtml(state.project.title)}" class="w-full p-3 border-4 border-gray-800 rounded-xl font-bold focus:outline-none focus:border-pink-500" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block font-bold text-gray-700 mb-2">種類</label>
                <select data-bind="project.type" class="w-full p-3 border-4 border-gray-800 rounded-xl font-bold focus:outline-none focus:border-pink-500 appearance-none bg-white">
                  <option value="manga" ${state.project.type === 'manga' ? 'selected' : ''}>漫画</option>
                  <option value="novel" ${state.project.type === 'novel' ? 'selected' : ''}>小説</option>
                </select>
              </div>
              <div>
                <label class="block font-bold text-gray-700 mb-2">単位 (Pなど)</label>
                <input type="text" data-bind="project.unitName" value="${escapeHtml(state.project.unitName)}" class="w-full p-3 border-4 border-gray-800 rounded-xl font-bold focus:outline-none focus:border-pink-500" />
              </div>
            </div>
            <div>
              <label class="block font-bold text-gray-700 mb-2">全体の量 (総ページ数など)</label>
              <input type="number" data-bind="project.totalUnits" value="${state.project.totalUnits}" class="w-full p-3 border-4 border-gray-800 rounded-xl font-bold focus:outline-none focus:border-pink-500" min="1" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block font-bold text-gray-700 mb-2">開始日</label>
                <input type="date" data-bind="project.startDate" value="${escapeHtml(state.project.startDate)}" class="w-full p-3 border-4 border-gray-800 rounded-xl font-bold focus:outline-none focus:border-pink-500" />
              </div>
              <div>
                <label class="block font-bold text-gray-700 mb-2">しめきり日</label>
                <input type="date" data-bind="project.deadline" value="${escapeHtml(state.project.deadline)}" class="w-full p-3 border-4 border-gray-800 rounded-xl font-bold focus:outline-none focus:border-pink-500" />
              </div>
            </div>
          </div>
        </div>
      `;
    };

    const renderConciergeSettings = () => {
      const stateLabels = {
        default: { label: "通常時", color: "text-gray-600" },
        good: { label: "順調な時", color: "text-orange-500" },
        panic: { label: "ピンチの時", color: "text-blue-500" },
        success: { label: "完了時", color: "text-pink-500" }
      };

      const statesHTML = Object.entries(state.concierge.states).map(([stateKey, stateData]) => `
        <div class="border-l-4 pl-4 border-gray-800">
          <h3 class="font-black text-lg mb-3 ${stateLabels[stateKey].color}">${stateLabels[stateKey].label}</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-1">
                <i data-lucide="image" class="w-4 h-4"></i> キャラクター画像
              </label>
              <div class="flex flex-col gap-2">
                <div class="flex items-center gap-3">
                  <input type="file" accept="image/*" id="file-${stateKey}" data-action="upload-image" data-state-key="${stateKey}" class="hidden" />
                  <label for="file-${stateKey}" class="cursor-pointer bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                    <i data-lucide="upload" class="w-4 h-4"></i> 画像を選択
                  </label>
                  ${stateData.imageUrl && stateData.imageUrl.startsWith('data:image') ? `<span class="text-xs text-green-700 font-bold bg-green-100 px-2 py-1 rounded">アップロード済</span>` : ''}
                </div>
                <div class="flex items-center gap-2 text-sm">
                  <span class="text-gray-500 font-bold text-xs w-10 text-center">または</span>
                  <input type="text" data-bind="concierge.states.${stateKey}.imageUrl" value="${escapeHtml(stateData.imageUrl)}" placeholder="https://... (画像URL)" class="flex-1 p-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-gray-800 text-sm" />
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-1">セリフ</label>
              <textarea data-bind="concierge.states.${stateKey}.message" rows="3" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-gray-800 text-sm font-bold">${escapeHtml(stateData.message)}</textarea>
            </div>
          </div>
        </div>
      `).join('');

      return `
        <div class="space-y-6 bg-white p-6 rounded-2xl border-4 border-gray-800 shadow-sm">
          <h2 class="text-xl font-black text-gray-800 flex items-center gap-2 mb-6">
            <i data-lucide="user-circle"></i> コンシェルジュ設定
          </h2>
          
          <div class="mb-8 p-4 bg-pink-50 rounded-xl border-2 border-pink-200">
            <h3 class="font-black text-lg mb-2 text-pink-700 flex items-center gap-2">
              <i data-lucide="message-square" class="w-5 h-5"></i> タップした時のおしゃべり
            </h3>
            <p class="text-xs font-bold text-pink-600 mb-2">※空行（1行あける）で別のセリフとして分かれます。</p>
            <textarea data-bind="concierge.tips" rows="6" placeholder="こまめに保存しよう！&#13;&#10;&#13;&#10;休憩も大事だよ！" class="w-full p-3 border-2 border-pink-300 rounded-lg focus:outline-none focus:border-pink-500 text-sm font-bold bg-white">${escapeHtml(state.concierge.tips)}</textarea>
          </div>

          <p class="text-sm font-bold text-gray-600 mb-6 bg-gray-100 p-4 rounded-xl leading-relaxed">
            画像をアップロードするか、URLを入力するとキャラが変わります。<br/>
            <span class="text-pink-600">■ 推奨サイズ:</span> 縦横400px〜600px程度<br/>
            ※大きい画像でも自動で軽いサイズに縮小されます。<br/>
            <span class="text-pink-600">{days}</span> : 残り日数 / 
            <span class="text-pink-600">{pace}</span> : 今のペース / 
            <span class="text-pink-600">{requiredPace}</span> : 必要なペース / 
            <span class="text-pink-600">{unit}</span> : 単位
          </p>

          <div class="space-y-8">${statesHTML}</div>
        </div>
      `;
    };

    const renderApp = () => {
      if (state.loading) {
        appDiv.innerHTML = `<div class="flex items-center justify-center min-h-[50vh]"><i data-lucide="loader-2" class="animate-spin text-pink-500 w-12 h-12"></i></div>`;
        lucide.createIcons();
        return;
      }

      let contentHTML = '';
      if (state.currentView === 'dashboard') contentHTML = renderDashboard();
      else if (state.currentView === 'settings_project') contentHTML = renderProjectSettings();
      else if (state.currentView === 'settings_concierge') contentHTML = renderConciergeSettings();

      appDiv.innerHTML = `<div id="app-header"></div><main>${contentHTML}</main>`;
      renderHeaderOnly();
      lucide.createIcons();
    };

    // --- イベントリスナー設定 ---
    appDiv.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;

      const action = btn.dataset.action;
      if (action === 'nav') {
        if (btn.dataset.save === 'true') saveData();
        state.currentView = btn.dataset.view;
        renderApp();
      }
      else if (action === 'progress') {
        const stepId = btn.dataset.step;
        const delta = Number(btn.dataset.delta);
        const current = state.progress[stepId] || 0;
        state.progress[stepId] = Math.max(0, Math.min(state.project.totalUnits, current + delta));

        updateSpeechStatus();
        saveData(); // プログレスは自動保存
        renderApp();
      }
      else if (action === 'tap-character') {
        let tipsList = state.concierge.tips ? state.concierge.tips.split(/\n\s*\n/).map(t => t.trim()).filter(Boolean) : [];
        if (tipsList.length === 0) tipsList = ["ファイトー！"];

        if (state.speechState.type === 'status') {
          const luckyMsg = getLuckyDayMessage();
          if (luckyMsg) state.speechState = { type: 'lucky', text: luckyMsg };
          else state.speechState = { type: 'tip', text: tipsList[Math.floor(Math.random() * tipsList.length)] };
        } else if (state.speechState.type === 'lucky') {
          state.speechState = { type: 'tip', text: tipsList[Math.floor(Math.random() * tipsList.length)] };
        } else {
          if (Math.random() > 0.5) updateSpeechStatus();
          else state.speechState = { type: 'tip', text: tipsList[Math.floor(Math.random() * tipsList.length)] };
        }

        // state更新後にrenderAppを呼んで画像を更新する
        renderApp();
      }
    });

    const handleDataBind = (e) => {
      const bindPath = e.target.dataset.bind;
      if (!bindPath) return;

      const val = e.target.type === 'number' ? Number(e.target.value) : e.target.value;
      const keys = bindPath.split('.');
      let current = state;
      for (let i = 0; i < keys.length - 1; i++) {
        current = current[keys[i]];
      }
      current[keys[keys.length - 1]] = val;

      // プロジェクトタイプ変更時は進捗をリセット
      if (bindPath === 'project.type') {
        state.progress = {};
      }

      // 変更を自動保存（少し遅延させて連続入力をまとめる）
      clearTimeout(window._saveTimer);
      window._saveTimer = setTimeout(() => {
        saveData();
      }, 1000);
    };

    // 入力フォームのデータバインディング (入力時にStateを自動更新し、保存)
    appDiv.addEventListener('input', handleDataBind);
    // selectなどの変更イベントも拾って保存する
    appDiv.addEventListener('change', (e) => {
      if (e.target.dataset.bind) {
        handleDataBind(e);
      }
    });

    // 画像アップロードのイベントハンドラ
    appDiv.addEventListener('change', async (e) => {
      if (e.target.matches('[data-action="upload-image"]')) {
        const stateKey = e.target.dataset.stateKey;
        const file = e.target.files[0];
        if (!file) return;
        try {
          const base64Url = await processImageFile(file);
          state.concierge.states[stateKey].imageUrl = base64Url;
          saveData(); // 画像変更時にすぐ保存
          renderApp(); // 画像更新のため再描画
        } catch (error) {
          console.error("画像の処理に失敗しました:", error);
        }
      }
    });

    // --- 初期化フロー (localStorage) ---
    const initApp = () => {
      try {
        const savedDataStr = localStorage.getItem('genko55_data');
        if (savedDataStr) {
          const savedData = JSON.parse(savedDataStr);
          if (savedData.project) state.project = savedData.project;
          if (savedData.progress) state.progress = savedData.progress;
          if (savedData.concierge) state.concierge = { ...DEFAULT_CONCIERGE, ...savedData.concierge };
        }
      } catch (error) {
        console.error("Load error:", error);
      }

      state.loading = false;
      updateSpeechStatus();
      renderApp();
    };

    // アプリ起動
    initApp();
  </script>
</body>

</html>